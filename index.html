<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hunter Diamonds — Card Reference</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#8ea3bb; --text:#e7edf5; --accent:#5cc8ff; --accent-2:#9bffd6;
      --chip:#1b2430; --chip-border:#2a3442; --border:#1a2330; --panel:#0f1621;
      --percent-ink:#ffffff; /* color for % readout on hover */
    }
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text);
      background:linear-gradient(180deg,#0a0f15,#0b1017 30%,#0e141d)
    }

    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(1.2) blur(6px);
      background:rgba(11,16,23,.85);
      border-bottom:1px solid #0f1722;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    h1{font-size:clamp(20px,2.2vw,28px); margin:0 0 6px}
    .sub{color:var(--muted); font-size:13px}

    .layout{max-width:1200px; margin:16px auto; display:grid; grid-template-columns: 1fr; gap:14px; padding:0 16px}
    main{min-height:60vh}

    .controls{
      display:grid; grid-template-columns: 200px 1fr 170px 170px 160px 130px;
      gap:10px; margin-bottom:12px
    }
    .controls input, .controls select, .controls button{
      background:#0e1520; color:var(--text); border:1px solid #1d2734;
      border-radius:10px; padding:10px 12px; outline:none; font-size:14px
    }
    .controls input::placeholder{color:#708095}

    .panel{background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .panel-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; background:var(--panel); border-bottom:1px solid #1a2330}
    .panel-title{font-weight:700}
    .hint{color:#8ea3bb; font-size:12px}

    /* ——— Card Grid ——— */
    .card-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px; padding: 16px;
    }
    .animal-card {
      background:#121821; border:1px solid #1a2330; border-radius:14px; padding:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.3); position:relative;
    }
    .animal-card::before{
      content:""; position:absolute; inset:-40% -40% auto auto; height:160px; width:160px;
      background:conic-gradient(from 120deg at 50% 50%, rgba(74,168,255,.18), rgba(255,255,255,.05), rgba(74,168,255,.18));
      filter:blur(12px); opacity:.35; pointer-events:none; border-radius:50%;
    }

    .card-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .card-title { font-weight:700; font-size:16px; line-height:1.1 }
    .class-badge { background:#0d1620; padding:6px 10px; border-radius:10px; font-size:12px; color:#5cc8ff; font-weight:700; border:1px solid #1a2330; }
    .row { margin:6px 0; font-size:13px; display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .label{font-size:.75rem; color:var(--muted)}
    .diamond {
      background:#0a2233; border:1px solid #2e9dd8; padding:2px 6px;
      border-radius:6px; color:#5cc8ff; font-weight:800; letter-spacing:.2px
    }
    .chip {
      background:var(--chip); border:1px solid var(--chip-border); padding:4px 8px;
      border-radius:10px; font-size:12px; color:#c6d3e6; white-space:nowrap
    }

    .variants { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px }
    .variant {
      position:relative;
      padding:4px 8px; border-radius:999px; font-size:12px;
      background:#1b2430; border:1px solid #2a3442; color:#c6d3e6;
    }

    .legend{padding:0 16px 16px; display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .legend strong{margin-right:6px}

    .density button{cursor:pointer}
    .compact .card-grid{gap:10px}
    .compact .animal-card{padding:10px}
    .compact .variant{padding:3px 7px; font-size:11px}

    @media (max-width: 1100px){ .controls{ grid-template-columns: 1fr 1fr 1fr 1fr; } }
    @media (max-width: 700px){ .controls{ grid-template-columns: 1fr 1fr; } }

    /* === Metallic rarity colors === */
    .variant.common{
      background: linear-gradient(145deg, #654a3a, #7a5a45);
      border-color: #8e6b50;
      color:#0b0f14;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.18), inset 0 -1px 0 rgba(0,0,0,.35);
    }
    .variant.uncommon{
      background: linear-gradient(145deg, #dfe3e8, #aeb6bf);
      border-color: #c3c9d1;
      color:#0b0f14;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6), inset 0 -1px 0 rgba(0,0,0,.35);
    }
    .variant.rare{
      background: linear-gradient(145deg, #f7e6a1, #caa74b);
      border-color: #e2c874;
      color:#0b0f14;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.5), inset 0 -1px 0 rgba(120,84,0,.35);
    }
    .variant.ultra{
      background: linear-gradient(145deg, #ff6b6b, #a92222);
      border-color: #d24b4b;
      color:#0b0f14;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(80,0,0,.35);
    }

    /* Hover-to-reveal percentages on variant chips (high contrast) */
    .variant[data-percent]:hover,
    .variant[data-percent]:active{ color:transparent; }
    .variant[data-percent]:hover::after,
    .variant[data-percent]:active::after{
      content:""; position:absolute; inset:0; border-radius:inherit;
      background: rgba(0,0,0,.28); pointer-events:none; z-index:1;
    }
    .variant[data-percent]:hover::before,
    .variant[data-percent]:active::before{
      content: attr(data-percent);
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      color:var(--percent-ink); font-weight:800; letter-spacing:.2px;
      text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 8px rgba(0,0,0,.7);
      pointer-events:none; z-index:2; white-space:nowrap;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between;">
      <div>
        <h1>Hunter Diamonds — Card Reference</h1>
        <div class="sub">Card grid version — all species details at a glance. Filters and last selection are remembered.</div>
      </div>
      <div class="density"><button id="toggleDensity" aria-pressed="false">Compact On/Off</button></div>
    </div>
  </header>

  <div class="layout">
    <main>
      <div class="controls">
        <select id="mapSelect"><option value="">Select map…</option></select>
        <input id="search" type="search" placeholder="Search animals, variants, notes…"/>
        <select id="classFilter"><option value="">All Classes</option></select>
        <select id="sexFilter">
          <option value="">All Sexes</option>
          <option value="M">Male-only</option>
          <option value="F">Female-only</option>
          <option value="MF">Both</option>
        </select>
        <select id="sortBy">
          <option value="animal">Sort: Animal A→Z</option>
          <option value="class">Sort: Class ↑</option>
          <option value="diamond">Sort: Diamond ↓</option>
        </select>
        <button id="resetBtn">Reset</button>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div>
            <div class="panel-title" id="panel-title">Select a map</div>
            <div class="sub" id="panel-sub">—</div>
          </div>
          <div class="hint">Tip: Use Compact mode to fit ~13–16 cards per screen.</div>
        </div>
        <div id="panel-body">
          <div class="card-grid" id="cards"></div>
        </div>
      </div>

      <div class="legend">
        <strong>Legend:</strong>
        <span class="variant common">Common</span>
        <span class="variant uncommon">Uncommon</span>
        <span class="variant rare">Rare</span>
        <span class="variant ultra">Ultra Rare</span>
      </div>
    </main>
  </div>

  <script>
/* =========================
   MAPS
   ========================= */
const MAPS_BASE = [
  { id:"layton", name:"Layton Lake District", region:"Pacific Northwest, USA" },
  { id:"hirsch", name:"Hirschfelden Hunting Reserve", region:"Germany" }
];
const MAPS_DLC = [
  { id:"medved",      name:"Medved-Taiga National Park",     region:"Siberia, Russia" },
  { id:"vurhonga",    name:"Vurhonga Savanna Reserve",       region:"Africa" },
  { id:"parque",      name:"Parque Fernando",                region:"Argentina" },
  { id:"yukon",       name:"Yukon Valley",                   region:"Alaska" },
  { id:"cuatro",      name:"Cuatro Colinas Game Reserve",    region:"Spain" },
  { id:"silverridge", name:"Silver Ridge Peaks",             region:"Colorado" },
  { id:"teawaroa",    name:"Te Awaroa National Park",        region:"New Zealand" },
  { id:"rancho",      name:"Rancho del Arroyo",              region:"Mexico" },
  { id:"mississippi", name:"Mississippi Acres Preserve",     region:"USA" },
  { id:"revontuli",   name:"Revontuli Coast",                region:"Finland" },
  { id:"newengland",  name:"New England Mountains",          region:"USA" },
  { id:"emerald",     name:"Emerald Coast",                  region:"Australia" },
  { id:"sundarpatan", name:"Sundarpatan",                    region:"Nepal / Himalayas" },
  { id:"salzwiesen",  name:"Salzwiesen Park",                region:"Germany" },
  { id:"askiy",       name:"Askiy Ridge Hunting Preserve",   region:"Canada" }
];
const MAPS_BY_ID = [...MAPS_BASE, ...MAPS_DLC].reduce((a,m)=> (a[m.id]=m, a), {});

/* =========================
   ELEMENTS & STATE
   ========================= */
const els = {
  map: document.getElementById('mapSelect'),
  search: document.getElementById('search'),
  classFilter: document.getElementById('classFilter'),
  sexFilter: document.getElementById('sexFilter'),
  sortBy: document.getElementById('sortBy'),
  cards: document.getElementById('cards'),
  title: document.getElementById('panel-title'),
  sub: document.getElementById('panel-sub'),
  reset: document.getElementById('resetBtn')
};

[...MAPS_BASE, ...MAPS_DLC].forEach(m=>{
  const o=document.createElement('option'); o.value=m.id; o.textContent=`${m.name}`; els.map.appendChild(o);
});

const LS_KEY='hunter.cards.v1';
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify({
    map: els.map.value,
    q: els.search.value,
    cls: els.classFilter.value,
    sex: els.sexFilter.value,
    sort: els.sortBy.value,
    compact: document.body.classList.contains('compact')
  }));
}
function loadState(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch{ return {}; }
}

/* =========================
   DATA LOADING (species.json)
   ========================= */
let SPECIES = [];

async function loadSpecies(){
  try{
    const res = await fetch('species.json', { cache: 'no-store' });
    if(!res.ok) throw new Error('species.json not found');
    SPECIES = await res.json();
    window.SPECIES = SPECIES; // expose for console debugging
  }catch(e){
    console.warn('Could not load species.json:', e);
    SPECIES = [];
  }
}

function populateClassFilter(){
  els.classFilter.innerHTML = '<option value="">All Classes</option>';
  const classes = Array.from(new Set(SPECIES.map(s=>s.class))).sort((a,b)=>a-b);
  classes.forEach(c=>{
    const o=document.createElement('option');
    o.value=c; o.textContent=`Class ${c}`;
    els.classFilter.appendChild(o);
  });
}

/* =========================
   HELPERS
   ========================= */
function rarityClass(name){
  const n = (name||'').toLowerCase();
  if(n.includes('ultra') || n.includes('great one') || n.includes('super')) return 'ultra';
  if(n.includes('albino') || n.includes('melanistic') || n.includes('leucistic') || n.includes('piebald')) return 'rare';
  if(n.includes('uncommon') || n.includes('blonde') || n.includes('grey') || n.includes('gray')) return 'uncommon';
  return '';
}

// Percent thresholds (tune these if you want)
const RARITY_THRESHOLDS = {
  ultra: 0.1,     // < 0.1%  = Ultra
  rare: 1,        // < 1%    = Rare
  uncommon: 10    // < 10%   = Uncommon
  // >= 10% = Common
};
function rarityFromPercent(pctStr) {
  if (!pctStr) return "";
  const n = parseFloat(String(pctStr).replace("%",""));
  if (isNaN(n)) return "";
  if (n < RARITY_THRESHOLDS.ultra) return "ultra";
  if (n < RARITY_THRESHOLDS.rare) return "rare";
  if (n < RARITY_THRESHOLDS.uncommon) return "uncommon";
  return "common";
}

function sexAbbrev(sex){
  const s = (sex||'').replace(/\s+/g,'').toUpperCase();
  if(s.includes('M/F') || s.includes('⚥')) return 'M / F';
  if(s.includes('M') && s.includes('F')) return 'M / F';
  if(/♂/.test(sex)) return 'M';
  if(/♀/.test(sex)) return 'F';
  return sex || '—';
}

function normalizeVariant(raw) {
  if (typeof raw === "string") {
    const m = raw.match(/^(.*?)(?:\s+(\d+(?:\.\d+)?%))$/);
    if (m) return { name: m[1].trim(), pct: m[2], rarity: "" };
    return { name: raw.trim(), pct: "", rarity: "" };
  }
  if (raw && typeof raw === "object") {
    const name = (raw.name || "").trim();
    const pct  = (raw.percent || raw.pct || "").toString();
    const rarity = raw.rarity || "";
    return { name, pct, rarity };
  }
  return { name: String(raw || "").trim(), pct: "", rarity: "" };
}

function variantChip(raw) {
  const v = normalizeVariant(raw);
  const rcls = v.rarity || rarityFromPercent(v.pct) || rarityClass(v.name) || "common";
  const pctAttr = v.pct ? ` data-percent="${v.pct}" title="${v.pct}"` : "";
  return `<span class="variant ${rcls}"${pctAttr}>${v.name}</span>`;
}

/* =========================
   RENDER
   ========================= */
function cardHTML(a){
  const variants = Array.isArray(a.variants) ? a.variants : [];
  return `
  <article class="animal-card" role="group" aria-label="${a.animal}">
    <div class="card-head">
      <div class="card-title">${a.animal}</div>
      <span class="class-badge">Class ${a.class}</span>
    </div>
    <div class="row"><span class="label">Diamond</span> <span class="diamond">${Number(a.diamond).toFixed(2)}</span></div>
    <div class="row"><span class="label">Max Diff.</span> <span class="chip">${a.maxDifficulty}</span></div>
    <div class="row"><span class="label">Basis</span> <span class="chip">${a.basis}</span></div>
    <div class="row"><span class="label">Min Weight</span> <span class="chip">${a.minWeight || '–'}</span>
         <span class="label">Sex</span> <span class="chip">${sexAbbrev(a.sex)}</span></div>
    <div class="row"><span class="label">Fur Variants</span></div>
    <div class="variants">
      ${variants.map(v => variantChip(v)).join("")}
    </div>
  </article>`;
}

function applyFilters(){
  let list = Array.isArray(SPECIES) ? SPECIES : [];
  if (!list.length) {
    els.cards.innerHTML = '<div class="row" style="padding:16px;color:#8ea3bb;">No species loaded. Add <code>species.json</code> to this folder.</div>';
    els.title.textContent = 'No species loaded';
    els.sub.textContent = 'Add species.json';
    saveState();
    return;
  }

  const map = els.map.value;
  const q = els.search.value.toLowerCase().trim();
  const cls = els.classFilter.value;
  const sex = els.sexFilter.value;
  const sortBy = els.sortBy.value;

  if(map) list = list.filter(s=> (s.maps||[]).includes(map));
  if(cls) list = list.filter(s=> String(s.class) === String(cls));
  if(sex){
    if(sex==='MF') list = list.filter(s=> /M/i.test(s.sex||'') && /F/i.test(s.sex||''));
    else list = list.filter(s=> (s.sex||'').toUpperCase().includes(sex));
  }
  if(q){
    list = list.filter(a=>{
      const hay = [a.animal, a.basis, a.maxDifficulty, a.minWeight, a.sex, ...(a.variants||[])].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }
  // sort
  list = list.slice().sort((a,b)=>{
    if(sortBy==='class') return a.class - b.class || a.animal.localeCompare(b.animal);
    if(sortBy==='diamond') return (b.diamond||0) - (a.diamond||0);
    return a.animal.localeCompare(b.animal);
  });

  els.cards.innerHTML = list.map(cardHTML).join('');

  // panel header
  if(map){
    const m = MAPS_BY_ID[map];
    els.title.textContent = `${m.name}`;
    els.sub.textContent = m.region || '';
  } else {
    els.title.textContent = 'All Maps';
    els.sub.textContent = '—';
  }

  saveState();
}

/* =========================
   LISTENERS + BOOTSTRAP
   ========================= */
['input','change'].forEach(evt=>{
  els.search.addEventListener(evt, applyFilters);
  els.classFilter.addEventListener(evt, applyFilters);
  els.sexFilter.addEventListener(evt, applyFilters);
  els.sortBy.addEventListener(evt, applyFilters);
  els.map.addEventListener(evt, applyFilters);
});

document.getElementById('toggleDensity').addEventListener('click', ()=>{
  document.body.classList.toggle('compact');
  const on = document.body.classList.contains('compact');
  document.getElementById('toggleDensity').setAttribute('aria-pressed', on? 'true':'false');
  saveState();
});

els.reset.addEventListener('click', ()=>{
  els.map.value=''; els.search.value=''; els.classFilter.value=''; els.sexFilter.value=''; els.sortBy.value='animal';
  applyFilters();
});

// Bootstrap (load JSON first, then build UI)
(async function init(){
  const state = loadState();
  if(state.compact) document.body.classList.add('compact');

  await loadSpecies();
  populateClassFilter();

  if(state.map) els.map.value = state.map;
  if(state.q)   els.search.value = state.q;
  if(state.cls) els.classFilter.value = state.cls;
  if(state.sex) els.sexFilter.value = state.sex;
  if(state.sort)els.sortBy.value = state.sort;

  applyFilters();
})();
  </script>
</body>
</html>
