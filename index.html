<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hunter Diamonds — Card Reference</title>
  <style>
    /* (keep all your CSS as-is) */
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between;">
      <div>
        <h1>Hunter Diamonds — Card Reference</h1>
        <div class="sub">Card grid version — all species details at a glance. Filters and last selection are remembered.</div>
      </div>
      <div class="density"><button id="toggleDensity" aria-pressed="false">Compact On/Off</button></div>
    </div>
  </header>

  <div class="layout">
    <main>
      <div class="controls">
        <select id="mapSelect"><option value="">Select map…</option></select>
        <input id="search" type="search" placeholder="Search animals, variants, notes…"/>
        <select id="classFilter"><option value="">All Classes</option></select>
        <select id="sexFilter">
          <option value="">All Sexes</option>
          <option value="M">Male-only</option>
          <option value="F">Female-only</option>
          <option value="MF">Both</option>
        </select>
        <select id="sortBy">
          <option value="animal">Sort: Animal A→Z</option>
          <option value="class">Sort: Class ↑</option>
          <option value="diamond">Sort: Diamond ↓</option>
        </select>
        <button id="resetBtn">Reset</button>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div>
            <div class="panel-title" id="panel-title">Select a map</div>
            <div class="sub" id="panel-sub">—</div>
          </div>
          <div class="hint">Tip: Use Compact mode to fit ~13–16 cards per screen.</div>
        </div>
        <div id="panel-body">
          <div class="card-grid" id="cards"></div>
        </div>
      </div>

      <div class="legend">
        <strong>Legend:</strong>
        <span class="variant common">Common</span>
        <span class="variant uncommon">Uncommon</span>
        <span class="variant rare">Rare</span>
        <span class="variant ultra">Ultra Rare</span>
      </div>
    </main>
  </div>

  <script>
/* =========================
   MAPS
   ========================= */
const MAPS_BASE = [
  { id:"layton", name:"Layton Lake District", region:"Pacific Northwest, USA" },
  { id:"hirsch", name:"Hirschfelden Hunting Reserve", region:"Germany" }
];
const MAPS_DLC = [
  { id:"medved",      name:"Medved-Taiga National Park",     region:"Siberia, Russia" },
  { id:"vurhonga",    name:"Vurhonga Savanna Reserve",       region:"Africa" },
  { id:"parque",      name:"Parque Fernando",                region:"Argentina" },
  { id:"yukon",       name:"Yukon Valley",                   region:"Alaska" },
  { id:"cuatro",      name:"Cuatro Colinas Game Reserve",    region:"Spain" },
  { id:"silverridge", name:"Silver Ridge Peaks",             region:"Colorado" },
  { id:"teawaroa",    name:"Te Awaroa National Park",        region:"New Zealand" },
  { id:"rancho",      name:"Rancho del Arroyo",              region:"Mexico" },
  { id:"mississippi", name:"Mississippi Acres Preserve",     region:"USA" },
  { id:"revontuli",   name:"Revontuli Coast",                region:"Finland" },
  { id:"newengland",  name:"New England Mountains",          region:"USA" },
  { id:"emerald",     name:"Emerald Coast",                  region:"Australia" },
  { id:"sundarpatan", name:"Sundarpatan",                    region:"Nepal / Himalayas" },
  { id:"salzwiesen",  name:"Salzwiesen Park",                region:"Germany" },
  { id:"askiy",       name:"Askiy Ridge Hunting Preserve",   region:"Canada" }
];
const MAPS_BY_ID = [...MAPS_BASE, ...MAPS_DLC].reduce((a,m)=> (a[m.id]=m, a), {});

/* =========================
   ELEMENTS & STATE
   ========================= */
const els = {
  map: document.getElementById('mapSelect'),
  search: document.getElementById('search'),
  classFilter: document.getElementById('classFilter'),
  sexFilter: document.getElementById('sexFilter'),
  sortBy: document.getElementById('sortBy'),
  cards: document.getElementById('cards'),
  title: document.getElementById('panel-title'),
  sub: document.getElementById('panel-sub'),
  reset: document.getElementById('resetBtn')
};

[...MAPS_BASE, ...MAPS_DLC].forEach(m=>{
  const o=document.createElement('option'); o.value=m.id; o.textContent=`${m.name}`; els.map.appendChild(o);
});

const LS_KEY='hunter.cards.v1';
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify({
    map: els.map.value,
    q: els.search.value,
    cls: els.classFilter.value,
    sex: els.sexFilter.value,
    sort: els.sortBy.value,
    compact: document.body.classList.contains('compact')
  }));
}
function loadState(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch{ return {}; }
}

/* =========================
   LOAD SPECIES
   ========================= */
async function loadSpecies() {
  let url = 'species.json';
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    const raw = await res.json();

    let flat = [];
    if (Array.isArray(raw)) {
      flat = raw;
    } else if (raw && typeof raw === 'object') {
      flat = Object.entries(raw).flatMap(([mapName, arr]) => {
        if (!Array.isArray(arr)) return [];
        return arr.map(o => ({
          ...o,
          variants: Array.isArray(o.variants) ? o.variants : [],
          maps: Array.isArray(o.maps) ? o.maps : [mapName]
        }));
      });
    } else {
      throw new Error('Unrecognized JSON format');
    }

    window.SPECIES = flat.filter(Boolean);
  } catch (err) {
    console.error('Failed to load species.json:', err);
    const el = document.getElementById('cards') || document.body;
    el.innerHTML = `<div style="color:#f88;padding:12px;border:1px solid #f88;border-radius:8px">
      Failed to load <code>${url}</code>: ${err.message}
    </div>`;
  }
}

/* =========================
   HELPERS
   ========================= */
function rarityClass(name){
  const n = (name||'').toLowerCase();
  if(n.includes('ultra') || n.includes('great one') || n.includes('super')) return 'ultra';
  if(n.includes('albino') || n.includes('melanistic') || n.includes('leucistic') || n.includes('piebald')) return 'rare';
  if(n.includes('uncommon') || n.includes('blonde') || n.includes('grey') || n.includes('gray')) return 'uncommon';
  return '';
}

function populateClassFilter(){
  els.classFilter.innerHTML = '<option value="">All Classes</option>';
  const classes = Array.from(new Set(SPECIES.map(s=>s.class))).sort((a,b)=>a-b);
  classes.forEach(c=>{
    const o=document.createElement('option');
    o.value=c; o.textContent=`Class ${c}`;
    els.classFilter.appendChild(o);
  });
}

const RARITY_THRESHOLDS = { ultra:0.1, rare:1, uncommon:10 };
function rarityFromPercent(pctStr) {
  if (!pctStr) return "";
  const n = parseFloat(String(pctStr).replace("%",""));
  if (isNaN(n)) return "";
  if (n < RARITY_THRESHOLDS.ultra) return "ultra";
  if (n < RARITY_THRESHOLDS.rare) return "rare";
  if (n < RARITY_THRESHOLDS.uncommon) return "uncommon";
  return "common";
}

function sexAbbrev(sex){
  const s = (sex||'').replace(/\s+/g,'').toUpperCase();
  if(s.includes('M/F') || s.includes('⚥')) return 'M / F';
  if(s.includes('M') && s.includes('F')) return 'M / F';
  if(/♂/.test(sex)) return 'M';
  if(/♀/.test(sex)) return 'F';
  return sex || '—';
}

function normalizeVariant(raw) {
  if (typeof raw === "string") {
    const m = raw.match(/^(.*?)(?:\s+(\d+(?:\.\d+)?%))$/);
    if (m) return { name: m[1].trim(), pct: m[2], rarity: "" };
    return { name: raw.trim(), pct: "", rarity: "" };
  }
  if (raw && typeof raw === "object") {
    const name = (raw.name || "").trim();
    const pct  = (raw.percent || raw.pct || "").toString();
    const rarity = raw.rarity || "";
    return { name, pct, rarity };
  }
  return { name: String(raw || "").trim(), pct: "", rarity: "" };
}

function variantChip(raw) {
  const v = normalizeVariant(raw);
  const rcls = v.rarity || rarityFromPercent(v.pct) || rarityClass(v.name) || "common";
  const pctAttr = v.pct ? ` data-percent="${v.pct}" title="${v.pct}"` : "";
  return `<span class="variant ${rcls}"${pctAttr}>${v.name}</span>`;
}

/* =========================
   RENDER + FILTER
   ========================= */
function cardHTML(a){
  const variants = Array.isArray(a.variants) ? a.variants : [];
  return `
  <article class="animal-card" role="group" aria-label="${a.animal}">
    <div class="card-head">
      <div class="card-title">${a.animal}</div>
      <span class="class-badge">Class ${a.class}</span>
    </div>
    <div class="row"><span class="label">Diamond</span> <span class="diamond">${Number(a.diamond).toFixed(2)}</span></div>
    <div class="row"><span class="label">Max Diff.</span> <span class="chip">${a.maxDifficulty}</span></div>
    <div class="row"><span class="label">Basis</span> <span class="chip">${a.basis}</span></div>
    <div class="row"><span class="label">Min Weight</span> <span class="chip">${a.minWeight || '–'}</span>
         <span class="label">Sex</span> <span class="chip">${sexAbbrev(a.sex)}</span></div>
    <div class="row"><span class="label">Fur Variants</span></div>
    <div class="variants">
      ${variants.map(v => variantChip(v)).join("")}
    </div>
  </article>`;
}

function applyFilters(){
  let list = Array.isArray(SPECIES) ? SPECIES : [];
  if (!list.length) {
    els.cards.innerHTML = '<div class="row" style="padding:16px;color:#8ea3bb;">No species loaded. Add <code>species.json</code> to this folder.</div>';
    els.title.textContent = 'No species loaded';
    els.sub.textContent = 'Add species.json';
    saveState();
    return;
  }

  const map = els.map.value;
  const q = els.search.value.toLowerCase().trim();
  const cls = els.classFilter.value;
  const sex = els.sexFilter.value;
  const sortBy = els.sortBy.value;

  if(map) list = list.filter(s=> (s.maps||[]).includes(map));
  if(cls) list = list.filter(s=> String(s.class) === String(cls));
  if(sex){
    if(sex==='MF') list = list.filter(s=> /M/i.test(s.sex||'') && /F/i.test(s.sex||''));
    else list = list.filter(s=> (s.sex||'').toUpperCase().includes(sex));
  }
  if(q){
    list = list.filter(a=>{
      const hay = [a.animal, a.basis, a.maxDifficulty, a.minWeight, a.sex, ...(a.variants||[])].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }
  list = list.slice().sort((a,b)=>{
    if(sortBy==='class') return a.class - b.class || a.animal.localeCompare(b.animal);
    if(sortBy==='diamond') return (b.diamond||0) - (a.diamond||0);
    return a.animal.localeCompare(b.animal);
  });

  els.cards.innerHTML = list.map(cardHTML).join('');

  if(map){
    const m = MAPS_BY_ID[map];
    els.title.textContent = `${m.name}`;
    els.sub.textContent = m.region || '';
  } else {
    els.title.textContent = 'All Maps';
    els.sub.textContent = '—';
  }

  saveState();
}

/* =========================
   LISTENERS + BOOTSTRAP
   ========================= */
['input','change'].forEach(evt=>{
  els.search.addEventListener(evt, applyFilters);
  els.classFilter.addEventListener(evt, applyFilters);
  els.sexFilter.addEventListener(evt, applyFilters);
  els.sortBy.addEventListener(evt, applyFilters);
  els.map.addEventListener(evt, applyFilters);
});

document.getElementById('toggleDensity').addEventListener('click', ()=>{
  document.body.classList.toggle('compact');
  const on = document.body.classList.contains('compact');
  document.getElementById('toggleDensity').setAttribute('aria-pressed', on? 'true':'false');
  saveState();
});

els.reset.addEventListener('click', ()=>{
  els.map.value=''; els.search.value=''; els.classFilter.value=''; els.sexFilter.value=''; els.sortBy.value='animal';
  applyFilters();
});

// Bootstrap (load JSON first, then build UI)
(async function init(){
  const state = loadState();
  if (state.compact) document.body.classList.add('compact');

  await loadSpecies();
  populateClassFilter();

  if (state.map)  els.map.value = state.map;
  if (state.q)    els.search.value = state.q;
  if (state.cls)  els.classFilter.value = state.cls;
  if (state.sex)  els.sexFilter.value = state.sex;
  if (state.sort) els.sortBy.value = state.sort;

  applyFilters();
})();
</script>
</body>
</html>
